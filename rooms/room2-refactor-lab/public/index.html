<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room 2: Invoice Generator</title>
    <style>
        body { font-family: sans-serif; padding: 2rem; background: #f0f2f5; }
        .card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        pre { background: #fee; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.9rem; }
        .success { background: #e6fffa; color: #2c7a7b; }
        .complex { border-left: 4px solid #e53e3e; }
        button { background: #3182ce; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        button:hover { background: #2c5282; }
    </style>
</head>
<body>
    <div class="card">
        <h1>üßæ Legacy Invoice Engine</h1>
        <p>This system handles billing. The code is messy and hard to maintain.</p>
        <p><strong>Goal:</strong> Refactor `src/invoiceEngine.js` to reduce complexity.</p>
        
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 2rem;">
                <button onclick="generate()">‚ö° 1. Test Logic (Generate Invoice)</button>
                <button onclick="validate()" style="background-color: #805ad5;">üîç 2. Check Code Quality</button>
            </div>

            <div id="quality-result" style="margin-top: 1rem;"></div>
            <div id="result" style="margin-top: 2rem;"></div>
    </div>

    <script>
        async function validate() {
            const el = document.getElementById('quality-result');
            el.innerHTML = '<p>Running ESLint complexity check...</p>';
            try {
                const req = await fetch('/api/validate-complexity');
                const data = await req.json();
                
                if (data.ok) {
                    el.innerHTML = `<div style="background:#f0fff4; padding:1rem; border:1px solid #c6f6d5; color: green; font-weight: bold;">${data.message}</div>`;
                } else {
                    const details = (data.details || 'No details provided.').trim();
                    el.innerHTML = `<div style="background:#fff5f5; padding:1rem; border:1px solid #feb2b2; color: #c53030;">
                        <strong>${data.message}</strong>
                        <pre style="background:transparent; padding:0; margin-top:5px; white-space:pre-wrap;">${details}</pre>
                    </div>`;
                }
            } catch (e) {
                el.innerHTML = `<pre>Error running check: ${e.message}</pre>`;
            }
        }

        async function generate() {
            const el = document.getElementById('result');
            el.innerHTML = '<p>Processing (Legacy Slow)...</p>';
            
            try {
                // Mock payload specifically designed to trigger complex logic
                const payload = {
                    items: [
                        { sku: 'VIP-SUB-YEAR', qty: 1, unitPrice: 1200, type: 'subscription' },
                        { sku: 'SETUP-FEE', qty: 1, unitPrice: 150, type: 'service' },
                        { sku: 'SUPPORT-HR', qty: 5, unitPrice: 60, type: 'service' }
                    ],
                    discountCode: 'VIP20',
                    shippingAddress: { country: 'PT' },
                    region: 'EU',
                    isB2B: true
                };

                const res = await fetch('/api/invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                // Check if response is JSON to avoid parsing HTML errors
                const contentType = res.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("Server returned non-JSON response (Check console)");
                }

                const data = await res.json();
                
                if (!data.ok) {
                    el.innerHTML = `<pre class="complex" style="color: red;">Error: ${data.error}</pre>`;
                } else {
                    const inv = data.invoice;
                    const rows = inv.lines.map(l => `
                        <tr>
                            <td style="padding:8px; border-bottom:1px solid #eee;">${l.sku}</td>
                            <td style="padding:8px; border-bottom:1px solid #eee;">${l.qty}</td>
                            <td style="padding:8px; border-bottom:1px solid #eee;">‚Ç¨${l.unitPrice}</td>
                            <td style="padding:8px; border-bottom:1px solid #eee;">‚Ç¨${l.lineTotal}</td>
                        </tr>
                    `).join('');

                    el.innerHTML = `
                        <div style="background:white; padding:1.5rem; border-radius:8px; border:1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; border-bottom:2px solid #3182ce; padding-bottom:0.5rem;">
                                <h3 style="margin:0; color:#2d3748;">üßæ Invoice #${Date.now().toString().slice(-6)}</h3>
                                <span style="background:#c6f6d5; color:#22543d; padding:4px 8px; border-radius:4px; font-size:0.8rem;">PAID</span>
                            </div>
                            
                            <table style="width:100%; border-collapse:collapse; text-align:left; font-size:0.95rem;">
                                <thead>
                                    <tr style="background:#f7fafc; color:#4a5568;">
                                        <th style="padding:8px;">Item</th>
                                        <th style="padding:8px;">Qty</th>
                                        <th style="padding:8px;">Price</th>
                                        <th style="padding:8px;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>${rows}</tbody>
                            </table>

                            <div style="margin-top:1.5rem; text-align:right; border-top:1px solid #e2e8f0; padding-top:1rem;">
                                <div style="color:#718096; font-size:0.9rem;">Subtotal: ‚Ç¨${inv.amounts.subtotal}</div>
                                <div style="color:#718096; font-size:0.9rem;">Tax: ‚Ç¨${inv.amounts.tax}</div>
                                <div style="font-size:1.2rem; font-weight:bold; color:#2d3748; margin-top:0.5rem;">Total: ‚Ç¨${inv.amounts.total}</div>
                            </div>
                            
                            <div style="margin-top:1rem; font-size:0.8rem; color:#a0aec0; text-align:center;">
                                ‚è±Ô∏è Processed in ${data.meta.timeMs}ms | Currency: ${inv.currency}
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error(e);
                el.innerHTML = `<pre style="color:red">Network Error: ${e.message}</pre>`;
            }
        }
    </script>
</body>
</html>
