<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room 2: Invoice Generator</title>
    <style>
        body { font-family: sans-serif; padding: 2rem; background: #f0f2f5; }
        .team-bar { display: flex; gap: 8px; align-items: center; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #fafafa; margin-bottom: 16px; }
        .team-bar input { padding: 6px 8px; }
        .team-actions { margin-left: auto; display: flex; gap: 8px; }
        .team-status { font-size: 12px; color: #555; margin-bottom: 16px; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); max-width: 600px; margin: 0 auto; }
        pre { background: #fee; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.9rem; }
        .success { background: #e6fffa; color: #2c7a7b; }
        .complex { border-left: 4px solid #e53e3e; }
        button { background: #3182ce; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        button:hover { background: #2c5282; }
    </style>
</head>
<body>
    <div class="team-bar">
        <strong>Team</strong>
        <input type="text" id="teamName" placeholder="Team name" />
        <button onclick="joinTeam()">Join</button>
        <span id="teamStatus" class="team-status"></span>
        <div id="badges" style="display:flex; gap:4px; font-size:11px; margin-left:8px;"></div>
        <div style="margin-left: auto; display: flex; gap: 8px; align-items: center;">
            <div id="timer" style="padding: 6px 12px; background: #dcfce7; border-radius: 4px; font-weight: 600; color: #166534; font-size: 12px;">‚è±Ô∏è 50m 00s</div>
            <div class="team-actions">
                <button class="btn-secondary" onclick="openLeaderboard()">Leaderboard</button>
                <button onclick="goPrevRoom()">Prev Room</button>
                <button onclick="goNextRoom()">Next Room</button>
                <button id="markCompleteBtn" class="btn-secondary" onclick="markComplete()" disabled>Mark Complete</button>
            </div>
        </div>
    </div>

    <div class="card">
        <h1>üßæ Legacy Invoice Engine</h1>
        <p>This system handles billing. The code is messy and hard to maintain.</p>
        <p><strong>Goal:</strong> Refactor `src/invoiceEngine.js` to reduce complexity.</p>
        
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 2rem;">
                <button onclick="generate()">‚ö° 1. Test Logic (Generate Invoice)</button>
                <button onclick="validate()" style="background-color: #805ad5;">üîç 2. Check Code Quality</button>
            </div>

            <div id="quality-result" style="margin-top: 1rem;"></div>
            <div id="result" style="margin-top: 2rem;"></div>
    </div>

    <script src="/config.js"></script>
    <script>
        const CURRENT_ROOM = 'room2';
        const CFG = window.GAME_CONFIG || {};
        const ESCAPE_CFG = window.ESCAPE_ROOM_CONFIG || {};
        CFG.CURRENT_ROOM = CURRENT_ROOM;
        const HUB_BASE = CFG.GAME_HUB_URL || `${location.protocol}//${location.hostname}:4000`;
        const API_BASE_URL = ESCAPE_CFG.getApiUrl ? ESCAPE_CFG.getApiUrl() : HUB_BASE;
        const ROOM_ORDER = ['room1', 'room2', 'room3', 'final'];
        const ROOM_PORTS = { room1: 3000, room2: 3002, room3: 3003, final: 8080 };

        // Sync timer with Firebase every 5 seconds
        setInterval(async () => {
            try {
                const res = await fetch(`${API_BASE_URL}/timer`);
                const data = await res.json();
                if (data.ok && data.timer && data.timer.startTime) {
                    if (TIMING.startTime !== data.timer.startTime) {
                        TIMING.startTimer(data.timer.startTime);
                    }
                }
            } catch (e) {
                // Silent fail
            }
        }, 5000);

        const isDevEnv = location.hostname === 'localhost'
            || location.hostname === '127.0.0.1'
            || location.hostname.endsWith('.cloudworkstations.dev');
        let validationPassed = false;
        let teamState = { completedRooms: [] };

        function updateBadges() {
            const badge = document.getElementById('badges');
            badge.innerHTML = ROOM_ORDER.map((r, i) => {
                const done = teamState.completedRooms && teamState.completedRooms.includes(r);
                const icons = { room1: 'üèö', room2: 'üß±', room3: 'üîê', final: 'üè¢' };
                const labels = { room1: '1', room2: '2', room3: '3', final: 'F' };
                return `<span style="color: ${done ? '#22c55e' : '#888'}; font-weight: bold;" title="${r}">${icons[r]} ${labels[r]}</span>`;
            }).join('');
        }

        function setMarkCompleteEnabled(enabled) {
            const btn = document.getElementById('markCompleteBtn');
            if (btn) btn.disabled = !enabled;
        }

        setMarkCompleteEnabled(!isDevEnv);

        async function fetchTeamState() {
            try {
                const res = await fetch(`${API_BASE_URL}/state`);
                const data = await res.json();
                if (data.ok && data.teams) {
                    const me = data.teams.find(t => t.name === getTeamName());
                    if (me) {
                        teamState = me;
                        updateBadges();
                    }
                }
            } catch (e) {
                console.error('Failed to fetch team state:', e);
            }
        }

        function getTeamName() {
            return localStorage.getItem('teamName') || '';
        }

        function setTeamName(name) {
            localStorage.setItem('teamName', name);
            document.getElementById('teamName').value = name;
        }

        async function joinTeam() {
            const name = document.getElementById('teamName').value.trim();
            if (!name) return alert('Enter a team name');
            setTeamName(name);
            await fetch(`${API_BASE_URL}/team/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            await updateTeam({ room: CURRENT_ROOM, status: 'in-progress' });
            document.getElementById('teamStatus').textContent = `Connected as ${name}`;
            fetchTeamState();
        }

        async function updateTeam(payload) {
            const name = getTeamName();
            if (!name) return;
            await fetch(`${API_BASE_URL}/team/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, ...payload })
            });
        }

        function openLeaderboard() {
            window.open(`${HUB_BASE}/`, '_blank');
        }

        function goToRoom(roomId) {
            updateTeam({ room: roomId, status: 'in-progress', result: `Moved to ${roomId}` });
            const fallbackPort = ROOM_PORTS[roomId];
            const fallbackUrl = fallbackPort ? `${location.protocol}//${location.hostname}:${fallbackPort}/` : '';
            const targetUrl = (CFG.getRoomUrl && CFG.getRoomUrl(roomId)) || fallbackUrl;
            if (!targetUrl) return;
            window.location.href = targetUrl;
        }

        function goPrevRoom() {
            const idx = ROOM_ORDER.indexOf(CURRENT_ROOM);
            if (idx > 0) goToRoom(ROOM_ORDER[idx - 1]);
        }

        function goNextRoom() {
            const idx = ROOM_ORDER.indexOf(CURRENT_ROOM);
            if (idx < 0 || idx >= ROOM_ORDER.length - 1) return;

            if (!teamState.completedRooms || !teamState.completedRooms.includes(CURRENT_ROOM)) {
                alert('‚ùå Completa a sala atual primeiro!');
                return;
            }

            goToRoom(ROOM_ORDER[idx + 1]);
        }

        async function markComplete() {
            const name = getTeamName();
            if (!name) return alert('Enter a team name');
            if (isDevEnv && !validationPassed) {
                return alert('Completa a validacao de complexidade antes de marcar a sala.');
            }

            await fetch(`${API_BASE_URL}/team/complete-room`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, roomId: CURRENT_ROOM })
            });

            document.getElementById('teamStatus').textContent = '‚úÖ Room marked complete!';
            fetchTeamState();
        }

        async function validate() {
            const el = document.getElementById('quality-result');
            el.innerHTML = '<p>Running ESLint complexity check...</p>';
            try {
                const req = await fetch('/api/validate-complexity');
                const data = await req.json();
                
                if (data.ok) {
                    el.innerHTML = `<div style="background:#f0fff4; padding:1rem; border:1px solid #c6f6d5; color: green; font-weight: bold;">${data.message}</div>`;
                    validationPassed = true;
                    setMarkCompleteEnabled(true);
                    updateTeam({ room: CURRENT_ROOM, status: 'in-progress', result: 'Complexity OK' });
                    fetchTeamState();
                } else {
                    const details = (data.details || 'No details provided.').trim();
                    el.innerHTML = `<div style="background:#fff5f5; padding:1rem; border:1px solid #feb2b2; color: #c53030;">
                        <strong>${data.message}</strong>
                        <pre style="background:transparent; padding:0; margin-top:5px; white-space:pre-wrap;">${details}</pre>
                    </div>`;
                    updateTeam({ room: CURRENT_ROOM, status: 'in-progress', result: 'Complexity too high' });
                }
            } catch (e) {
                el.innerHTML = `<pre>Error running check: ${e.message}</pre>`;
            }
        }

        async function generate() {
            const el = document.getElementById('result');
            el.innerHTML = '<p>Processing (Legacy Slow)...</p>';
            
            try {
                // Mock payload specifically designed to trigger complex logic
                const payload = {
                    items: [
                        { sku: 'VIP-SUB-YEAR', qty: 1, unitPrice: 1200, type: 'subscription' },
                        { sku: 'SETUP-FEE', qty: 1, unitPrice: 150, type: 'service' },
                        { sku: 'SUPPORT-HR', qty: 5, unitPrice: 60, type: 'service' }
                    ],
                    discountCode: 'VIP20',
                    shippingAddress: { country: 'PT' },
                    region: 'EU',
                    isB2B: true
                };

                const res = await fetch('/api/invoice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                // Check if response is JSON to avoid parsing HTML errors
                const contentType = res.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    throw new Error("Server returned non-JSON response (Check console)");
                }

                const data = await res.json();
                
                if (!data.ok) {
                    el.innerHTML = `<pre class="complex" style="color: red;">Error: ${data.error}</pre>`;
                } else {
                    const inv = data.invoice;
                    const rows = inv.lines.map(l => `
                        <tr>
                            <td style="padding:8px; border-bottom:1px solid #eee;">${l.sku}</td>
                            <td style="padding:8px; border-bottom:1px solid #eee;">${l.qty}</td>
                            <td style="padding:8px; border-bottom:1px solid #eee;">‚Ç¨${l.unitPrice}</td>
                            <td style="padding:8px; border-bottom:1px solid #eee;">‚Ç¨${l.lineTotal}</td>
                        </tr>
                    `).join('');

                    el.innerHTML = `
                        <div style="background:white; padding:1.5rem; border-radius:8px; border:1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; border-bottom:2px solid #3182ce; padding-bottom:0.5rem;">
                                <h3 style="margin:0; color:#2d3748;">üßæ Invoice #${Date.now().toString().slice(-6)}</h3>
                                <span style="background:#c6f6d5; color:#22543d; padding:4px 8px; border-radius:4px; font-size:0.8rem;">PAID</span>
                            </div>
                            
                            <table style="width:100%; border-collapse:collapse; text-align:left; font-size:0.95rem;">
                                <thead>
                                    <tr style="background:#f7fafc; color:#4a5568;">
                                        <th style="padding:8px;">Item</th>
                                        <th style="padding:8px;">Qty</th>
                                        <th style="padding:8px;">Price</th>
                                        <th style="padding:8px;">Total</th>
                                    </tr>
                                </thead>
                                updateTeam({ room: CURRENT_ROOM, status: 'in-progress', result: 'Invoice generated' });
                                <tbody>${rows}</tbody>
                            </table>

                            <div style="margin-top:1.5rem; text-align:right; border-top:1px solid #e2e8f0; padding-top:1rem;">
                                <div style="color:#718096; font-size:0.9rem;">Subtotal: ‚Ç¨${inv.amounts.subtotal}</div>
                                <div style="color:#718096; font-size:0.9rem;">Tax: ‚Ç¨${inv.amounts.tax}</div>

                    (function initTeam() {
                        const saved = getTeamName();
                        if (saved) {
                            document.getElementById('teamName').value = saved;
                            document.getElementById('teamStatus').textContent = `Connected as ${saved}`;
                            updateTeam({ room: CURRENT_ROOM, status: 'in-progress', result: 'Opened Room 2' });
                        }
                    })();
                                <div style="font-size:1.2rem; font-weight:bold; color:#2d3748; margin-top:0.5rem;">Total: ‚Ç¨${inv.amounts.total}</div>
                            </div>
                            
                            <div style="margin-top:1rem; font-size:0.8rem; color:#a0aec0; text-align:center;">
                                ‚è±Ô∏è Processed in ${data.meta.timeMs}ms | Currency: ${inv.currency}
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                console.error(e);
                el.innerHTML = `<pre style="color:red">Network Error: ${e.message}</pre>`;
            }
        }

        const savedTeam = getTeamName();
        if (savedTeam) {
            setTeamName(savedTeam);
            joinTeam();
            setTimeout(fetchTeamState, 500);
        }
        
        // Refresh badges every 3s
        setInterval(fetchTeamState, 3000);
    </script>
</body>
</html>
